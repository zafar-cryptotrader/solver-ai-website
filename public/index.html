<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solver.AI</title>
    
    <!-- Professional Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- MathJax Configuration -->
    <script>
        MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']], 
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: { fontCache: 'global' },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        /* --- PROFESSIONAL THEME --- */
        :root {
            /* Backgrounds: Deep Slate */
            --bg-app: #0f172a;       /* Slate 900 */
            --bg-panel: #1e293b;     /* Slate 800 */
            
            /* Accents: "Intellectual Blue" */
            --primary: #3b82f6;      /* Blue 500 */
            --primary-dim: #1d4ed8;  /* Blue 700 */
            --secondary: #06b6d4;    /* Cyan 500 */
            
            /* Gradients */
            --gradient-main: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            --gradient-glow: radial-gradient(circle at top center, rgba(56, 189, 248, 0.15), transparent 70%);

            /* Glassmorphism */
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(148, 163, 184, 0.1);
            
            /* Text */
            --text-main: #f1f5f9;    /* Slate 100 */
            --text-muted: #94a3b8;   /* Slate 400 */
            
            --font-main: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --max-width: 850px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- BACKGROUND AMBIENCE --- */
        .background-glow {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--gradient-glow);
            z-index: -1;
            pointer-events: none;
        }

        /* --- HEADER --- */
        .app-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 50;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-main);
            letter-spacing: -0.01em;
            cursor: pointer;
        }
        
        .brand-icon {
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* New Chat Button */
        .btn-reset {
            font-size: 0.85rem;
            padding: 6px 12px;
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-reset:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            border-color: rgba(255,255,255,0.2);
        }

        /* --- CHAT AREA --- */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            scroll-behavior: smooth;
        }

        /* Scrollbar */
        .chat-area::-webkit-scrollbar { width: 5px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }
        
        .chat-content {
            width: 100%;
            max-width: var(--max-width);
            padding: 0 20px 140px 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- HERO SECTION --- */
        .hero {
            margin-top: 10vh;
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }
        
        .hero h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0 0 12px 0;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }
        
        .hero p {
            font-size: 1.05rem;
            color: var(--text-muted);
            line-height: 1.6;
            max-width: 480px;
            margin: 0 auto 40px auto;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
        }

        .suggestion-card {
            background: var(--bg-panel);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .suggestion-card:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-1px);
        }
        
        .card-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .suggestion-card:hover .card-icon {
            background: var(--primary);
            color: white;
        }

        .card-text { font-size: 0.9rem; color: var(--text-main); font-weight: 500; }

        @media (max-width: 600px) { .suggestions { grid-template-columns: 1fr; } }

        /* --- MESSAGES --- */
        .msg-row {
            display: flex;
            gap: 16px;
            width: 100%;
            animation: slideUp 0.3s ease-out;
        }
        
        .msg-row.user { justify-content: flex-end; }

        .avatar {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        
        .avatar.bot { background: var(--bg-panel); border: 1px solid var(--glass-border); color: var(--primary); }

        .bubble {
           /* max-width: 100%;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative; */
           
        }

        .msg-row.user .bubble {
            background: var(--gradient-main);
            color: #fff;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
            border-bottom-right-radius: 2px;
        }

        .msg-row.bot .bubble {
            background: var(--bg-panel);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            border-bottom-left-radius: 2px;
        }

        .img-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .img-grid img { height: 140px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); cursor: zoom-in; } 
        

        /* Markdown Styles */
        .bubble strong { font-weight: 600; color: inherit; }
        
        .code-box {
            background: #0f172a;
            border-radius: 8px;
            border: 1px solid #334155;
            margin: 10px 0;
            overflow: hidden;
            font-family: var(--font-code);
        }
        .code-header {
            background: #1e293b;
            padding: 6px 12px;
            font-size: 0.75rem;
            color: #94a3b8;
            border-bottom: 1px solid #334155;
        }
        .code-body {
            padding: 12px;
            overflow-x: auto;
            font-size: 0.85rem;
            color: #e2e8f0;
            white-space: pre;
        }

        /* --- INPUT AREA --- */
        .input-dock {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 24px;
            background: linear-gradient(to top, var(--bg-app) 20%, transparent);
            display: flex; justify-content: center;
            z-index: 100;
        }

        .input-bar {
            width: 100%;
            max-width: var(--max-width);
            background: var(--bg-panel);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
            position: relative;
        }

        .input-bar:focus-within {
            border-color: var(--primary);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15);
        }
        
        /* Drag Overlay */
        .drag-cover {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(30, 41, 59, 0.9);
            border: 2px dashed var(--primary);
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s;
            color: var(--primary); font-weight: 600;
        }
        .input-bar.drag-active .drag-cover { opacity: 1; pointer-events: all; }

        /* Preview Rail */
        .previews { display: none; padding: 10px 12px; gap: 10px; overflow-x: auto; border-bottom: 1px solid var(--glass-border); }
        .p-thumb { position: relative; width: 48px; height: 48px; flex-shrink: 0; }
        .p-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .p-remove {
            position: absolute; top: -6px; right: -6px; width: 16px; height: 16px;
            background: #ef4444; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer; border: 2px solid var(--bg-panel);
        }

        .controls { display: flex; align-items: flex-end; gap: 8px; padding: 6px; }

        .btn-icon {
            width: 36px; height: 36px; border-radius: 8px; border: none;
            background: transparent; color: var(--text-muted);
            font-size: 1.1rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }

        textarea {
            flex: 1; background: transparent; border: none; color: var(--text-main);
            font-family: var(--font-main); font-size: 0.95rem; line-height: 1.5;
            resize: none; max-height: 150px; padding: 8px 4px;
        }
        textarea::placeholder { color: rgba(148, 163, 184, 0.5); }

        .btn-submit {
            width: 36px; height: 36px; border-radius: 8px; border: none;
            background: var(--primary); color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; opacity: 0.5; pointer-events: none;
        }
        .btn-submit.ready { opacity: 1; pointer-events: all; }
        .btn-submit:hover { background: var(--primary-dim); }

        /* --- LOADING & ANIMATION --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .typing { display: flex; gap: 4px; padding: 6px 0; }
        .dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

    </style>
</head>
<body>

    <div class="background-glow"></div>

    <header class="app-header">
        <div class="brand" onclick="resetChat()">
            <i class="fas fa-shapes brand-icon"></i>
            <span>Solver.AI</span>
        </div>
        <!-- CHANGED: Replaced static badge with functional New Chat button -->
        <button class="btn-reset" onclick="resetChat()">
            <i class="fas fa-plus"></i> <span>New Chat</span>
        </button>
    </header>

    <div class="chat-area" id="scroll-wrapper">
        <div class="chat-content" id="chatbox">
            
            <!-- Hero Section -->
            <div class="hero" id="hero">
                <h1>Academic Doubt Solver</h1>
                <p>Upload problems from Physics, Chemistry, Math, or Biology. <br>Get step-by-step solutions instantly.</p>
                
                <div class="suggestions">
                    <div class="suggestion-card" onclick="setInput('Derive any important JEE physics formula')">
                        <div class="card-icon"><i class="fas fa-atom"></i></div>
                        <div class="card-text">Physics Derivations</div>
                    </div>
                    <div class="suggestion-card" onclick="setInput('Give important integrals for JEE')">
                        <div class="card-icon"><i class="fas fa-square-root-alt"></i></div>
                        <div class="card-text">Calculus Problems</div>
                    </div>
                    <div class="suggestion-card" onclick="setInput('Explain an important organic reaction mechanism')">
                        <div class="card-icon"><i class="fas fa-flask"></i></div>
                        <div class="card-text">Organic Chemistry</div>
                    </div>
                    <div class="suggestion-card" onclick="setInput('Describe some important biological processes for NEET')">
                        <div class="card-icon"><i class="fas fa-dna"></i></div>
                        <div class="card-text">Biology Concepts</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="input-dock">
        <div class="input-bar" id="drop-zone">
            <div class="drag-cover">Drop Image Here</div>
            
            <div class="previews" id="preview-rail"></div>

            <div class="controls">
                <button class="btn-icon" onclick="document.getElementById('file-upload').click()" title="Attach File">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="file-upload" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
                
                <textarea id="user-input" placeholder="Ask a question..." rows="1"></textarea>
                
                <button class="btn-submit" id="send-btn" onclick="sendMessage()">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC ---
        const API_URL = '/api/solve';
        let state = { images: [], processing: false };
        
        const els = {
            chat: document.getElementById('chatbox'),
            scroll: document.getElementById('scroll-wrapper'),
            input: document.getElementById('user-input'),
            rail: document.getElementById('preview-rail'),
            btn: document.getElementById('send-btn'),
            hero: document.getElementById('hero'),
            drop: document.getElementById('drop-zone')
        };

        // --- EVENTS ---
        els.input.addEventListener('input', () => { resizeInput(); checkState(); });
        els.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        // Drag & Drop
        ['dragenter','dragover'].forEach(e => els.drop.addEventListener(e, (ev) => { ev.preventDefault(); els.drop.classList.add('drag-active'); }));
        ['dragleave','drop'].forEach(e => els.drop.addEventListener(e, (ev) => { ev.preventDefault(); els.drop.classList.remove('drag-active'); }));
        els.drop.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        
        // Paste
        window.addEventListener('paste', (e) => {
            const files = Array.from((e.clipboardData || e.originalEvent.clipboardData).items)
                .filter(i => i.kind === 'file' && i.type.startsWith('image/'))
                .map(i => i.getAsFile());
            if(files.length) handleFiles(files);
        });

        // --- FUNCTIONS ---
        function setInput(text) {
            els.input.value = text;
            resizeInput();
            checkState();
            els.input.focus();
        }

        function handleFiles(files) {
            if(!files || !files.length) return;
            Array.from(files).forEach(f => {
                if(!f.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.images.push({ id: Date.now()+Math.random(), file: f, url: e.target.result });
                    renderRail();
                    checkState();
                };
                reader.readAsDataURL(f);
            });
            document.getElementById('file-upload').value = '';
        }

        function renderRail() {
            els.rail.innerHTML = '';
            els.rail.style.display = state.images.length ? 'flex' : 'none';
            state.images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'p-thumb';
                div.innerHTML = `<img src="${img.url}"><div class="p-remove" onclick="removeImg(${img.id})"><i class="fas fa-times"></i></div>`;
                els.rail.appendChild(div);
            });
        }

        window.removeImg = (id) => {
            state.images = state.images.filter(i => i.id !== id);
            renderRail();
            checkState();
        };

        // NEW: Function to reset the chat
        function resetChat() {
            // Remove all messages (but keep hero)
            const messages = els.chat.querySelectorAll('.msg-row');
            messages.forEach(msg => msg.remove());
            
            // Show Hero
            els.hero.style.display = 'block';
            
            // Reset State
            state.images = [];
            els.input.value = '';
            renderRail();
            resizeInput();
            checkState();
        }

        function resizeInput() {
            els.input.style.height = 'auto';
            els.input.style.height = Math.min(els.input.scrollHeight, 150) + 'px';
        }

        function checkState() {
            const hasContent = els.input.value.trim() || state.images.length;
            els.btn.classList.toggle('ready', hasContent);
        }

        async function sendMessage() {
            const text = els.input.value.trim();
            if((!text && !state.images.length) || state.processing) return;
            
            state.processing = true;
            if(els.hero.style.display !== 'none') els.hero.style.display = 'none';

            // User Message
            addMsg('user', text, [...state.images]);

            // Prepare Data
            const parts = [];
            if(text) {
                parts.push({ text: state.images.length ? "Question: " + text : text });
            }
            state.images.forEach(i => {
                parts.push({ inline_data: { mime_type: i.file.type, data: i.url.split(',')[1] } });
            });

            // Clear Input
            els.input.value = '';
            state.images = [];
            renderRail();
            resizeInput();
            checkState();

            // Loading
            const loadId = addLoader();

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts }] })
                });
                
                document.getElementById(loadId).remove();
                if(!res.ok) throw new Error("Server Error");
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                addMsg('bot', data.text);

            } catch (err) {
                if(document.getElementById(loadId)) document.getElementById(loadId).remove();
                addMsg('bot', `⚠️ Error: ${err.message}`);
            } finally {
                state.processing = false;
            }
        }

        function addMsg(role, text, imgs = []) {
            const div = document.createElement('div');
            div.className = `msg-row ${role}`;
            
            let html = '';
            if(imgs.length) html += `<div class="img-grid">${imgs.map(i => `<img src="${i.url}">`).join('')}</div>`;
            if(text) html += role === 'bot' ? formatText(text) : text.replace(/</g, "&lt;").replace(/\n/g, '<br>');

            div.innerHTML = `
                ${role === 'bot' ? `<div class="avatar bot"><i class="fas fa-shapes"></i></div>` : ''}
                <div class="bubble">${html}</div>
            `;
            els.chat.appendChild(div);
            if(role === 'bot') MathJax.typesetPromise([div]).catch(e => console.log(e));
            scrollToBottom();
        }

        function addLoader() {
            const id = 'l-' + Date.now();
            const div = document.createElement('div');
            div.className = 'msg-row bot';
            div.id = id;
            div.innerHTML = `
                <div class="avatar bot"><i class="fas fa-shapes"></i></div>
                <div class="bubble"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
            `;
            els.chat.appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() {
            setTimeout(() => els.scroll.scrollTo({ top: els.scroll.scrollHeight, behavior: 'smooth' }), 50);
        }

        function formatText(text) {
            let t = text.replace(/</g, "&lt;");
            t = t.replace(/```(\w*?)\n([\s\S]*?)\n```/g, '<div class="code-box"><div class="code-header">$1</div><div class="code-body">$2</div></div>');
            t = t.replace(/`([^`]+)`/g, '<span style="background:rgba(255,255,255,0.1); padding:2px 5px; border-radius:4px; font-family:var(--font-code); font-size:0.9em;">$1</span>');
            t = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            return t.replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
